
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://docs.hermez.io/zkEVM/State-Machines/Memory/memory-state-machine/">
      
      <link rel="icon" href="../../../../favicon.ico">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.3.9">
    
    
      
        <title>Memory - Polygon zkEVM Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.1d29e8d0.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#7e56c2">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="deep-purple" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#memory-state-machine" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="Polygon zkEVM Documentation" class="md-header__button md-logo" aria-label="Polygon zkEVM Documentation" data-md-component="logo">
      
  <img src="../../../../logo-white.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Polygon zkEVM Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Memory
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/hermeznetwork/hermez-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../Basic-Concepts/introduction/" class="md-tabs__link md-tabs__link--active">
        Polygon zkEVM
      </a>
    </li>
  

  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../../Hermez_1.0/about/scalability/" class="md-tabs__link">
        Polygon Hermez 1.0
      </a>
    </li>
  

  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Polygon zkEVM Documentation" class="md-nav__button md-logo" aria-label="Polygon zkEVM Documentation" data-md-component="logo">
      
  <img src="../../../../logo-white.svg" alt="logo">

    </a>
    Polygon zkEVM Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/hermeznetwork/hermez-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_1">
          Polygon zkEVM
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Polygon zkEVM" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Polygon zkEVM
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1_1" type="checkbox" id="__nav_1_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1_1">
          Basic Concepts
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Basic Concepts" data-md-level="2">
        <label class="md-nav__title" for="__nav_1_1">
          <span class="md-nav__icon md-icon"></span>
          Basic Concepts
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Basic-Concepts/introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Basic-Concepts/fibonacci/" class="md-nav__link">
        First Example: Fibonacci
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Basic-Concepts/simple-state-machine/" class="md-nav__link">
        Simple State Machine
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Basic-Concepts/modular-design/" class="md-nav__link">
        Modular Design
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1_2" type="checkbox" id="__nav_1_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1_2">
          Architecture
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Architecture" data-md-level="2">
        <label class="md-nav__title" for="__nav_1_2">
          <span class="md-nav__icon md-icon"></span>
          Architecture
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Architecture/zkProver/" class="md-nav__link">
        zkProver
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1_3" type="checkbox" id="__nav_1_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1_3">
          zkASM
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="zkASM" data-md-level="2">
        <label class="md-nav__title" for="__nav_1_3">
          <span class="md-nav__icon md-icon"></span>
          zkASM
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../zkASM/introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../zkASM/basic-syntax/" class="md-nav__link">
        Basic Syntax
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../zkASM/some-examples/" class="md-nav__link">
        Some Examples
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../zkASM/related-repos/" class="md-nav__link">
        Related Repositories
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1_4" type="checkbox" id="__nav_1_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1_4">
          PIL
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="PIL" data-md-level="2">
        <label class="md-nav__title" for="__nav_1_4">
          <span class="md-nav__icon md-icon"></span>
          PIL
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../PIL/introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../PIL/hello-world-examples/" class="md-nav__link">
        Hello Word Examples
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../PIL/components/" class="md-nav__link">
        Components
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../PIL/cyclical-nature/" class="md-nav__link">
        Cyclical Nature
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../PIL/modularity/" class="md-nav__link">
        Modularity
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../PIL/advanced-features/" class="md-nav__link">
        Advanced Features
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../PIL/related-repos/" class="md-nav__link">
        Related Repositories
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1_5" type="checkbox" id="__nav_1_5" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_1_5">
          State Machines
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="State Machines" data-md-level="2">
        <label class="md-nav__title" for="__nav_1_5">
          <span class="md-nav__icon md-icon"></span>
          State Machines
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Arithmetic/Arithmetic-State-Machine-typ/" class="md-nav__link">
        Arithmetic
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Storage/Storage-State-Machine-typ/" class="md-nav__link">
        Storage
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Hashing/Hashing-State-Machine-typ/" class="md-nav__link">
        Hashing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Binary/Binary-State-Machine-typ/" class="md-nav__link">
        Binary
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Memory
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Memory
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#evm-memory" class="md-nav__link">
    EVM Memory
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#layout" class="md-nav__link">
    Layout
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#design" class="md-nav__link">
    Design
  </a>
  
    <nav class="md-nav" aria-label="Design">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#execution-trace-design" class="md-nav__link">
    Execution Trace Design
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#list-of-columns" class="md-nav__link">
    List of Columns
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#complete-example" class="md-nav__link">
    Complete Example
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#constraints" class="md-nav__link">
    Constraints
  </a>
  
    <nav class="md-nav" aria-label="Constraints">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#topology" class="md-nav__link">
    Topology
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operation-selectors" class="md-nav__link">
    Operation Selectors
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#updating-the-value" class="md-nav__link">
    Updating the Value
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connection-with-the-main-sm" class="md-nav__link">
    Connection with the Main SM
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Memory-Align/memory-align-state-machine/" class="md-nav__link">
        Memory Align
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Complementary/complementary-state-machines/" class="md-nav__link">
        Complementaries
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Complementary/configuration-file/" class="md-nav__link">
        Configuration File
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Polygon Hermez 1.0
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Polygon Hermez 1.0" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Polygon Hermez 1.0
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_1">
          About
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="About" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          About
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Hermez_1.0/about/scalability/" class="md-nav__link">
        Ethereum Scalability and zk-Rollups
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Hermez_1.0/about/value-proposition/" class="md-nav__link">
        Polygon Hermez Value Proposition
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Hermez_1.0/about/model/" class="md-nav__link">
        Polygon Hermez Network Model
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Hermez_1.0/about/security/" class="md-nav__link">
        Security
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_2">
          Users
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Users" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Users
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Hermez_1.0/users/hermez-wallet/" class="md-nav__link">
        Polygon Hermez Wallet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Hermez_1.0/users/mainnet/" class="md-nav__link">
        Polygon Hermez Mainnet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Hermez_1.0/users/testnet/" class="md-nav__link">
        Polygon Hermez Testnet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Hermez_1.0/users/exchanges/" class="md-nav__link">
        Exchanges
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3" type="checkbox" id="__nav_2_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_3">
          Developers
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Developers" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          Developers
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Hermez_1.0/developers/dev-guide/" class="md-nav__link">
        Developer Guide
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3_2" type="checkbox" id="__nav_2_3_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_3_2">
          Protocol
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Protocol" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_3_2">
          <span class="md-nav__icon md-icon"></span>
          Protocol
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3_2_1" type="checkbox" id="__nav_2_3_2_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_3_2_1">
          Polygon Hermez zkRollup protocol
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Polygon Hermez zkRollup protocol" data-md-level="4">
        <label class="md-nav__title" for="__nav_2_3_2_1">
          <span class="md-nav__icon md-icon"></span>
          Polygon Hermez zkRollup protocol
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Hermez_1.0/developers/protocol/hermez-protocol/protocol/" class="md-nav__link">
        Core protocol
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Hermez_1.0/developers/protocol/hermez-protocol/contracts/contracts/" class="md-nav__link">
        Smart contracts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Hermez_1.0/developers/protocol/hermez-protocol/circuits/circuits/" class="md-nav__link">
        Circuits
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Hermez_1.0/developers/protocol/consensus/consensus/" class="md-nav__link">
        Forging consensus protocol
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Hermez_1.0/developers/protocol/withdrawal-delayer/withdrawal-delayer/" class="md-nav__link">
        Withdrawal delayer protocol
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Hermez_1.0/developers/sdk/" class="md-nav__link">
        Examples/SDK
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Hermez_1.0/developers/api/" class="md-nav__link">
        API
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Hermez_1.0/developers/batch-explorer/" class="md-nav__link">
        Batch Explorer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Hermez_1.0/developers/price-updater/" class="md-nav__link">
        Polygon Hermez NodePrice Updater
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Hermez_1.0/developers/glossary/" class="md-nav__link">
        Glossary
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_4" type="checkbox" id="__nav_2_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_4">
          FAQ
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="FAQ" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_4">
          <span class="md-nav__icon md-icon"></span>
          FAQ
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Hermez_1.0/faq/end-users/" class="md-nav__link">
        End-Users
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Hermez_1.0/faq/integrators/" class="md-nav__link">
        Integrators
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Hermez_1.0/faq/coordinators/" class="md-nav__link">
        Coordinators
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Hermez_1.0/faq/pod/" class="md-nav__link">
        Proof of Donation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Hermez_1.0/faq/other/" class="md-nav__link">
        Other
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#evm-memory" class="md-nav__link">
    EVM Memory
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#layout" class="md-nav__link">
    Layout
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#design" class="md-nav__link">
    Design
  </a>
  
    <nav class="md-nav" aria-label="Design">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#execution-trace-design" class="md-nav__link">
    Execution Trace Design
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#list-of-columns" class="md-nav__link">
    List of Columns
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#complete-example" class="md-nav__link">
    Complete Example
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#constraints" class="md-nav__link">
    Constraints
  </a>
  
    <nav class="md-nav" aria-label="Constraints">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#topology" class="md-nav__link">
    Topology
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operation-selectors" class="md-nav__link">
    Operation Selectors
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#updating-the-value" class="md-nav__link">
    Updating the Value
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connection-with-the-main-sm" class="md-nav__link">
    Connection with the Main SM
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/hermeznetwork/hermez-docs/edit/master/docs/zkEVM/State-Machines/Memory/memory-state-machine.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<h1 id="memory-state-machine">Memory State Machine</h1>
<p>As a secondary state machine, the Memory State Machine has the executor part (the Memory SM Executor) and an internal Memory PIL (program) which is a set of verification rules, written in the PIL language. The Memory SM Executor is written in two versions; Javascript and C/C++.</p>
<p>The Polygon Hermez Repo is here  <a href="https://github.com/0xPolygonHermez">https://github.com/0xPolygonHermez</a></p>
<p><strong>Memory SM Executor</strong>: <a href="https://github.com/0xPolygonHermez/zkevm-proverjs/tree/main/src/sm/sm_mem.js">sm_mem.js</a></p>
<p><strong>Memory SM PIL</strong>: <a href="https://github.com/0xPolygonHermez/zkevm-proverjs/blob/main/pil/mem.pil">mem.pil</a> </p>
<h2 id="evm-memory">EVM Memory</h2>
<p>The memory of the EVM (Ethereum Virtual Machine) is a volatile read-write memory, and it is used to store temporary data during the execution of transactions of smart contract functions. That is, data in memory is populated during transaction's execution but it does not persist between transactions. The memory is an array of <span class="arithmatex">\(256\)</span>-bit (<span class="arithmatex">\(32\)</span> bytes) words that can be accessed through <em>addresses at byte level</em>, that is to say, each byte in the memory has a different address.</p>
<p>Memory has addresses of <span class="arithmatex">\(32\)</span> bits, and initially, all memory locations are composed by bytes set to zero.</p>
<p>Now, let's see the layout in memory of the following two words <span class="arithmatex">\(\texttt{0xc417...81a7}\)</span> and <span class="arithmatex">\(\texttt{0x88d1...b723}\)</span>. Table 1 displays this layout.</p>
<p><center></p>
<table>
<thead>
<tr>
<th align="center"><span class="arithmatex">\(\mathbf{ADDRESS}\)</span></th>
<th align="center"><span class="arithmatex">\(\mathbf{BYTE}\)</span></th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><span class="arithmatex">\(\mathtt{0}\)</span></td>
<td align="center"><span class="arithmatex">\(\mathtt{0xc4}\)</span></td>
</tr>
<tr>
<td align="center"><span class="arithmatex">\(\mathtt{1}\)</span></td>
<td align="center"><span class="arithmatex">\(\mathtt{0x17}\)</span></td>
</tr>
<tr>
<td align="center"><span class="arithmatex">\(\mathtt{\vdots}\)</span></td>
<td align="center"><span class="arithmatex">\(\mathtt{\vdots}\)</span></td>
</tr>
<tr>
<td align="center"><span class="arithmatex">\(\mathtt{30}\)</span></td>
<td align="center"><span class="arithmatex">\(\mathtt{0x81}\)</span></td>
</tr>
<tr>
<td align="center"><span class="arithmatex">\(\mathtt{31}\)</span></td>
<td align="center"><span class="arithmatex">\(\mathtt{0xa7}\)</span></td>
</tr>
<tr>
<td align="center"><span class="arithmatex">\(\mathtt{32}\)</span></td>
<td align="center"><span class="arithmatex">\(\mathtt{0x88}\)</span></td>
</tr>
<tr>
<td align="center"><span class="arithmatex">\(\mathtt{33}\)</span></td>
<td align="center"><span class="arithmatex">\(\mathtt{0xd1}\)</span></td>
</tr>
<tr>
<td align="center"><span class="arithmatex">\(\mathtt{\vdots}\)</span></td>
<td align="center"><span class="arithmatex">\(\mathtt{\vdots}\)</span></td>
</tr>
<tr>
<td align="center"><span class="arithmatex">\(\mathtt{62}\)</span></td>
<td align="center"><span class="arithmatex">\(\mathtt{0xb7}\)</span></td>
</tr>
<tr>
<td align="center"><span class="arithmatex">\(\mathtt{63}\)</span></td>
<td align="center"><span class="arithmatex">\(\mathtt{0x23}\)</span></td>
</tr>
</tbody>
</table>
<p></center></p>
<div align="center"><b> Table 1: Layout in memory of 0xc417...81a7 and 0x88d1...b723. </b></div>

<p>Observe that each word has 32 bytes and that the words are stored in Big-Endian form. i.e. The most significant bytes are set in the lower addresses. The EVM provides three opcodes to interact with the memory area. There is an opcode to read, and an opcode to write 32-byte words providing an offset:</p>
<ul>
<li><span class="arithmatex">\(\texttt{MLOAD}\)</span>: It receives an offset and returns the 32 bytes in memory starting at that offset.</li>
<li><span class="arithmatex">\(\texttt{MSTORE}\)</span>: It receives an offset and saves 32 bytes from the offset address of the memory.</li>
</ul>
<p>Considering our previous memory contents, if we perform an <span class="arithmatex">\(\texttt{MLOAD}\)</span> with an offset of <span class="arithmatex">\(\texttt{1}\)</span>, we would obtain the following word: <span class="arithmatex">\(\texttt{0x17...a788}\)</span>. On the other hand, if we do an <span class="arithmatex">\(\texttt{MSTORE}\)</span> with an offset of <span class="arithmatex">\(\texttt{1}\)</span> with the word <span class="arithmatex">\(\texttt{0x74f0...ce92}\)</span>, we would modify the content of the memory as shown in Table 2.</p>
<p><center></p>
<table>
<thead>
<tr>
<th align="center"><span class="arithmatex">\(\mathbf{ADDRESS}\)</span></th>
<th align="center"><span class="arithmatex">\(\mathbf{BYTE}\)</span></th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><span class="arithmatex">\(\mathtt{0}\)</span></td>
<td align="center"><span class="arithmatex">\(\mathtt{0xc4}\)</span></td>
</tr>
<tr>
<td align="center"><span class="arithmatex">\(\mathtt{1}\)</span></td>
<td align="center"><span class="arithmatex">\(\mathtt{\textbf{0x74}}\)</span></td>
</tr>
<tr>
<td align="center"><span class="arithmatex">\(\mathtt{2}\)</span></td>
<td align="center"><span class="arithmatex">\(\mathtt{\textbf{0xf0}}\)</span></td>
</tr>
<tr>
<td align="center"><span class="arithmatex">\(\mathtt{\vdots}\)</span></td>
<td align="center"><span class="arithmatex">\(\mathtt{\vdots}\)</span></td>
</tr>
<tr>
<td align="center"><span class="arithmatex">\(\mathtt{30}\)</span></td>
<td align="center"><span class="arithmatex">\(\mathtt{\textbf{0xce}}\)</span></td>
</tr>
<tr>
<td align="center"><span class="arithmatex">\(\mathtt{31}\)</span></td>
<td align="center"><span class="arithmatex">\(\mathtt{\textbf{0x92}}\)</span></td>
</tr>
<tr>
<td align="center"><span class="arithmatex">\(\mathtt{33}\)</span></td>
<td align="center"><span class="arithmatex">\(\mathtt{0xd1}\)</span></td>
</tr>
<tr>
<td align="center"><span class="arithmatex">\(\mathtt{\vdots}\)</span></td>
<td align="center"><span class="arithmatex">\(\mathtt{\vdots}\)</span></td>
</tr>
<tr>
<td align="center"><span class="arithmatex">\(\mathtt{62}\)</span></td>
<td align="center"><span class="arithmatex">\(\mathtt{0xb7}\)</span></td>
</tr>
<tr>
<td align="center"><span class="arithmatex">\(\mathtt{63}\)</span></td>
<td align="center"><span class="arithmatex">\(\mathtt{0x23}\)</span></td>
</tr>
</tbody>
</table>
<p></center></p>
<div align="center"><b> Table 2: Layout in memory after the introduction of 0x74f0...ce92. </b></div>

<p>When the offset is not a multiple of 32 (or 0x20), as in the previous example, we have to use bytes from two different words when doing <span class="arithmatex">\(\texttt{MLOAD}\)</span> or <span class="arithmatex">\(\texttt{MSTORE}\)</span>.</p>
<p>Finally, the EVM provides a write memory operation that just writes a byte:</p>
<ul>
<li><span class="arithmatex">\(\texttt{MSTOREE}\)</span>: It receives an offset and saves one byte on that address of the memory.</li>
</ul>
<p>Notice that <span class="arithmatex">\(\texttt{MSTOREE}\)</span> always uses only one word.</p>
<h2 id="layout">Layout</h2>
<p>The Memory SM is in charge of proving the memory operations in the execution trace. As mentioned, read and write operations use addresses at byte level in the EVM. However, doing the proofs byte-by-byte would consume many values in the trace of this state machine. Instead, in this machine, we operate addressing words (32 bytes). For example, if we have the memory layout from Table 1, then we would have the memory layout of Table 3 with addresses that point to 32-byte words.</p>
<p><center></p>
<table>
<thead>
<tr>
<th align="center"><span class="arithmatex">\(\textbf{ADDRESS}\)</span></th>
<th align="center"><span class="arithmatex">\(\textbf{32-BYTE WORD}\)</span></th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><span class="arithmatex">\(\mathtt{0}\)</span></td>
<td align="center"><span class="arithmatex">\(\mathtt{0xc417...81a7}\)</span></td>
</tr>
<tr>
<td align="center"><span class="arithmatex">\(\mathtt{1}\)</span></td>
<td align="center"><span class="arithmatex">\(\mathtt{0x88d1...b723}\)</span></td>
</tr>
</tbody>
</table>
<p></center></p>
<div align="center"><b> Table 3: Layout in the memory state machine. </b></div>

<p>The Memory SM uses this latter layout, the 32-byte word access, to check reads and writes. However, as previously mentioned, the EVM can read and write with offsets at a byte level. As a result, we will need to check the relationship between byte access and 32-byte word access. For these checks, we have another state machine called Memory Align SM.</p>
<h2 id="design">Design</h2>
<p>As with any state machine, the Memory SM has an executor to compute the trace that proves the correctness of memory reads and writes and a PIL description that enforces that the trace is correct.</p>
<h3 id="execution-trace-design">Execution Trace Design</h3>
<p>The Memory SM defines the design of the trace and the PIL description that checks that memory reads and writes aligned to 32-byte words are correct. The addresses, denoted as <span class="arithmatex">\(\texttt{addr}\)</span>, are represented through <span class="arithmatex">\(32\)</span> bits (<span class="arithmatex">\(4\)</span> bytes) and point to 32-byte words. The value of words stored in memory, denoted as <span class="arithmatex">\(\texttt{val}\)</span>, are represented through <span class="arithmatex">\(8\)</span> registers <span class="arithmatex">\(\texttt{val[0..7]}\)</span> of <span class="arithmatex">\(4\)</span> bytes each, making a total of <span class="arithmatex">\(32\)</span> bytes (<span class="arithmatex">\(256\)</span> bits).</p>
<p>Table 4 shows an example with all the memory operations present at an execution trace of the Main SM.</p>
<p><center></p>
<table>
<thead>
<tr>
<th align="center"><span class="arithmatex">\(\texttt{step}\)</span></th>
<th align="center"><span class="arithmatex">\(\texttt{mOp}\)</span></th>
<th align="center"><span class="arithmatex">\(\texttt{mWr}\)</span></th>
<th align="center"><span class="arithmatex">\(\texttt{addr}\)</span></th>
<th align="center"><span class="arithmatex">\(\texttt{val[7]}\)</span></th>
<th align="center"><span class="arithmatex">\(\texttt{val[6]}\)</span></th>
<th align="center"><span class="arithmatex">\(\dots\)</span></th>
<th align="center"><span class="arithmatex">\(\texttt{val[0]}\)</span></th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">11</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">6</td>
<td align="center">2121</td>
<td align="center">3782</td>
<td align="center"><span class="arithmatex">\(\dots\)</span></td>
<td align="center">5432</td>
</tr>
<tr>
<td align="center">31</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">4</td>
<td align="center">3231</td>
<td align="center">9326</td>
<td align="center"><span class="arithmatex">\(\dots\)</span></td>
<td align="center">8012</td>
</tr>
<tr>
<td align="center">55</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">6</td>
<td align="center">2121</td>
<td align="center">3782</td>
<td align="center"><span class="arithmatex">\(\dots\)</span></td>
<td align="center">5432</td>
</tr>
<tr>
<td align="center">63</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">6</td>
<td align="center">4874</td>
<td align="center">1725</td>
<td align="center"><span class="arithmatex">\(\dots\)</span></td>
<td align="center">2074</td>
</tr>
<tr>
<td align="center">72</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">4</td>
<td align="center">3231</td>
<td align="center">9326</td>
<td align="center"><span class="arithmatex">\(\dots\)</span></td>
<td align="center">8012</td>
</tr>
<tr>
<td align="center">89</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">2</td>
<td align="center">9167</td>
<td align="center">5291</td>
<td align="center"><span class="arithmatex">\(\dots\)</span></td>
<td align="center">6001</td>
</tr>
</tbody>
</table>
<p></center></p>
<div align="center"><b> Table 4: Memory Operations and an Execution Trace of the Main SM. </b></div>

<p>The <span class="arithmatex">\(\texttt{step}\)</span> is the execution step number at the Main SM and in this case, we are showing only the steps that are performing a memory operation. The instruction to execute a memory operation is indicated by the <span class="arithmatex">\(\texttt{mOp}\)</span> selector. The <span class="arithmatex">\(\texttt{mWr}\)</span> is also a selector that shows whether the memory operation is a read or a write. In the previous trace, we can observe that the first memory operation is performed at step 11 and it is the write of the sixth 32-byte word. The eight registers <span class="arithmatex">\(\texttt{val[0..7]}\)</span> provide the bytes to be written in that word.</p>
<p>It is worth to mention that for a specific word address, the first operation is always a write because it makes no sense to read a position that has not been previously written. Then, in this word address there can be a sequence of reads and writes. In the previous trace, we can observe that for the sixth word, there is a write at step 11, then a read at step <span class="arithmatex">\(55\)</span> and finally another write at step <span class="arithmatex">\(63\)</span>.</p>
<p><center></p>
<table>
<thead>
<tr>
<th align="center"><span class="arithmatex">\(\texttt{step}\)</span></th>
<th align="center"><span class="arithmatex">\(\texttt{addr}\)</span></th>
<th align="center"><span class="arithmatex">\(\texttt{mOp}\)</span></th>
<th align="center"><span class="arithmatex">\(\texttt{mWr}\)</span></th>
<th align="center"><span class="arithmatex">\(\texttt{val[7]}\)</span></th>
<th align="center"><span class="arithmatex">\(\texttt{val[6]}\)</span></th>
<th align="center"><span class="arithmatex">\(\dots\)</span></th>
<th align="center"><span class="arithmatex">\(\texttt{val[0]}\)</span></th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">89</td>
<td align="center">2</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">9167</td>
<td align="center">5291</td>
<td align="center"><span class="arithmatex">\(\dots\)</span></td>
<td align="center">6001</td>
</tr>
<tr>
<td align="center">31</td>
<td align="center">4</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">3231</td>
<td align="center">9326</td>
<td align="center"><span class="arithmatex">\(\dots\)</span></td>
<td align="center">8012</td>
</tr>
<tr>
<td align="center">72</td>
<td align="center">4</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">3231</td>
<td align="center">9326</td>
<td align="center"><span class="arithmatex">\(\dots\)</span></td>
<td align="center">8012</td>
</tr>
<tr>
<td align="center">11</td>
<td align="center">6</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">2121</td>
<td align="center">3782</td>
<td align="center"><span class="arithmatex">\(\dots\)</span></td>
<td align="center">5432</td>
</tr>
<tr>
<td align="center">55</td>
<td align="center">6</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">2121</td>
<td align="center">3782</td>
<td align="center"><span class="arithmatex">\(\dots\)</span></td>
<td align="center">5432</td>
</tr>
<tr>
<td align="center">63</td>
<td align="center">6</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">4674</td>
<td align="center">1725</td>
<td align="center"><span class="arithmatex">\(\dots\)</span></td>
<td align="center">2074</td>
</tr>
</tbody>
</table>
<p></center></p>
<div align="center"><b> Table 5: Corresponding Memory SM Execution Trace. </b></div>

<p>The trace of the Memory SM must check that the writes are done according to their step and that reads provide the correct words according also to their step.</p>
<p>In order to implement these checks, the execution trace of the Memory SM sorts all the memory operations; firstly by <span class="arithmatex">\(\texttt{addr}\)</span>, and secondly by <span class="arithmatex">\(\texttt{step}\)</span>, as shown in Table 5. This ordering is referred to as the <em>topology</em> of the Memory SM.</p>
<p>Finally, we will need to add a few more columns to ensure that the memory execution trace goes exactly across all the ordered writes and reads of the Main SM, with writes storing the provided values and with reads not changing the previous value of the word.</p>
<p>In particular, we add three more columns. One these columns is called <span class="arithmatex">\(\texttt{INCS}\)</span> and it is used to provide an order for the values of the columns. Another column called <span class="arithmatex">\(\texttt{lastAccess}\)</span> is used to enable an address change when all the memory operations for this address have appeared at the trace. The last column is called <span class="arithmatex">\(\texttt{ISNOTLAST}\)</span> and it is used to make the checks pass when there are no more memory accesses.</p>
<h2 id="list-of-columns">List of Columns</h2>
<p>The following columns (polynomials) are used by the Memory SM. We divide them between preprocessed and committed polynomials.</p>
<p><strong>Preprocessed</strong>:</p>
<ul>
<li><span class="arithmatex">\(\texttt{INCS}\)</span>: Counter that goes from <span class="arithmatex">\(1\)</span> up to <span class="arithmatex">\(N\)</span>, where <span class="arithmatex">\(N\)</span> is the number of rows in the computational trace,</li>
</ul>
<div class="arithmatex">\[
\texttt{INCS} = (\underbrace{1, 2, 3, \dots,N-1, N}_{N})
\]</div>
<p>​ It is used to do a range check to prove the incremental order of other columns.</p>
<ul>
<li><span class="arithmatex">\(\texttt{ISNOTLAST}\)</span>: Selector that is <span class="arithmatex">\(1\)</span> in every row except in the <span class="arithmatex">\(N\)</span>-th row, in which its value is <span class="arithmatex">\(0\)</span>,</li>
</ul>
<div class="arithmatex">\[
\texttt{ISNOTLAST} = (\underbrace{1, 1, 1, \dots,1, 0}_{N})
\]</div>
<p><strong>Committed</strong>:</p>
<ul>
<li><span class="arithmatex">\(\texttt{step}\)</span>: Position in which the memory operation was called in the Main SM.</li>
<li><span class="arithmatex">\(\texttt{mOp}\)</span>: Selector indicating whether it is being performed a memory operation or not.</li>
<li><span class="arithmatex">\(\texttt{mWr}\)</span>: Selector that is <span class="arithmatex">\(1\)</span> if the memory operation is a write and <span class="arithmatex">\(0\)</span> if it is a read operation.</li>
<li><span class="arithmatex">\(\texttt{addr}\)</span>: A <span class="arithmatex">\(4\)</span>-byte (or <span class="arithmatex">\(32\)</span> bit) integer indicating the address of a 32-byte word.</li>
<li><span class="arithmatex">\(\texttt{lastAccess}\)</span>: Selector indicating whether it has been reached the last memory access for a particular address or not.</li>
<li><span class="arithmatex">\(\texttt{val[0..7]}\)</span>: Vector containing <span class="arithmatex">\(8\)</span> <span class="arithmatex">\(4\)</span>-byte integer indicating the <span class="arithmatex">\(256\)</span>-bit value associated to a given address.</li>
</ul>
<h2 id="complete-example">Complete Example</h2>
<p>Table 6 shows the complete Memory SM trace for our example in which the computational trace size <span class="arithmatex">\(N\)</span> is <span class="arithmatex">\(2^3\)</span>.</p>
<p>There are various important details to remark from the point in which all memory accesses have been completed but the <span class="arithmatex">\(2^3\)</span>-th row has not been reached yet:</p>
<ul>
<li><span class="arithmatex">\(\texttt{mOp}\)</span> and <span class="arithmatex">\(\texttt{mWr}\)</span> are set to <span class="arithmatex">\(0\)</span> until the last row.</li>
<li><span class="arithmatex">\(\texttt{addr}\)</span> is incremented by <span class="arithmatex">\(1\)</span> to keep the incremental order of the addresses. This value is maintained until the last row.</li>
<li><span class="arithmatex">\(\texttt{lastAccess}\)</span> is also set to <span class="arithmatex">\(0\)</span> except in the very last row, where it is set back to <span class="arithmatex">\(1\)</span> to create the ciclycity behavior.</li>
<li><span class="arithmatex">\(\texttt{step}\)</span> is incremented by <span class="arithmatex">\(1\)</span> in each row so that this column fulfills the constraints describing this state machine.</li>
<li><span class="arithmatex">\(\textbf{Remark}\)</span>. Notice that <span class="arithmatex">\(\texttt{step}\)</span> can take values beyond <span class="arithmatex">\(N\)</span> and that the value of <span class="arithmatex">\(\texttt{step}\)</span> after the row of the last address can coincide with a previous value. As we will show in the next section, where we describe the constraints, these facts do not cause any issue.</li>
<li><span class="arithmatex">\(\texttt{val[0..7]}\)</span> are all set to <span class="arithmatex">\(0\)</span> until the last row.</li>
</ul>
<p><img alt="" src="../figures/fig-tbl6-exec-trc.png" /></p>
<div align="center"><b> Table 6: Complete Memory SM execution trace for our example. </b></div>

<h2 id="constraints">Constraints</h2>
<h3 id="topology">Topology</h3>
<p>Let's start with the set of constraints regarding the topology of the state machine.</p>
<div class="arithmatex">\[
\begin{align}
&amp;\texttt{lastAccess} \cdot (\texttt{lastAccess} - 1) = 0,  \label{eq:lastAccessBin}\tag{1}\\
&amp;(1 - \texttt{lastAccess}) \cdot (\texttt{addr}' - \texttt{addr}) = 0, \label{eqaddresSame}\tag{2}\\
&amp;\texttt{ISNOTLAST}~\left \{ \texttt{lastAccess} \cdot \left( \texttt{addr}' - \texttt{addr} - (\texttt{step}' - \texttt{step}) \right) + (\texttt{step}' - \texttt{step}) \right \} \subset \texttt{INCS}. \label{eq:topology}\tag{3}
\end{align}
\]</div>
<p>Equations (1) and (2) are straightforward. Equation (1) asserts that <span class="arithmatex">\(\texttt{lastAccess}\)</span> is a selector (i.e., a column whose values lie in the set <span class="arithmatex">\(\{0,1\}\)</span>), while Equation (2) confirms that <span class="arithmatex">\(\texttt{addr}\)</span> does not change until it is accessed for the last time. Note that Equation (2) implies that addresses are processed one-by-one in the Memory SM, but it does not guarantees that they are ordered incrementally.</p>
<p>Equation (3) is a little bit more tricky. Let's do a case analysis on it.</p>
<p>The curly braces notation in Equation (3) means that the inclusion is only checked at values such that the corresponding selector <span class="arithmatex">\(\texttt{ISNOTLAST}\)</span> is equal to <span class="arithmatex">\(1\)</span>.</p>
<p>Then, depending on value of the <span class="arithmatex">\(\texttt{lastAccess}\)</span> selector we have two cases:</p>
<ul>
<li>If <span class="arithmatex">\(\texttt{lastAccess} = 0\)</span>:</li>
</ul>
<div class="arithmatex">\[
\texttt{step}' - \texttt{step} \subset \texttt{INCS}.
\]</div>
<ul>
<li>Else:</li>
</ul>
<div class="arithmatex">\[
\texttt{addr}' - \texttt{addr} \subset \texttt{INCS}.
\]</div>
<p>In words, whenever a transition do not change the address in question, verify that <span class="arithmatex">\(\texttt{step}' &gt; \texttt{step}\)</span>; otherwise verify that <span class="arithmatex">\(\texttt{addr}' &gt; \texttt{addr}\)</span>. Therefore, Equation (3) ensures that both <span class="arithmatex">\(\texttt{step}\)</span> and <span class="arithmatex">\(\texttt{addr}\)</span> are ordered incrementally (first by <span class="arithmatex">\(\texttt{addr}\)</span> and then by <span class="arithmatex">\(\texttt{step}\)</span>). A combination of Eqs. (2) and (3) gives the desired topology.</p>
<h3 id="operation-selectors">Operation Selectors</h3>
<p>Let's continue with the operation selectors: <span class="arithmatex">\(\texttt{mOp}\)</span> and <span class="arithmatex">\(\texttt{mWr}\)</span>.</p>
<div class="arithmatex">\[
\begin{align}
&amp;\texttt{mOp} \cdot (\texttt{mOp} - 1) = 0, \tag{4}\\
&amp;\texttt{mWr} \cdot (\texttt{mWr} - 1) = 0, \tag{5}\\
&amp;\left( 1 - \texttt{mOp} \right) \cdot \texttt{mWr} = 0. \tag{6}
\end{align}
\]</div>
<p>Eqs. (4) and (5) ensure that <span class="arithmatex">\(\texttt{mOp}\)</span> and <span class="arithmatex">\(\texttt{mWr}\)</span> are, effectively, selectors. Eq. (6) is imposing a restriction to <span class="arithmatex">\(\texttt{mWr}\)</span> (and binding it with <span class="arithmatex">\(\texttt{mOp}\)</span>) in the following sense: <span class="arithmatex">\(\texttt{mWr}\)</span> can be set to <span class="arithmatex">\(1\)</span> only if <span class="arithmatex">\(\texttt{mOp}\)</span> is also set to <span class="arithmatex">\(1\)</span>. Similarly, if <span class="arithmatex">\(\texttt{mOp}\)</span> is set to <span class="arithmatex">\(0\)</span>, then <span class="arithmatex">\(\texttt{mWr}\)</span> should be set to <span class="arithmatex">\(0\)</span> as well. This restriction comes naturally from the definition of these selectors.</p>
<h3 id="updating-the-value">Updating the Value</h3>
<p>Finally, we explain the constraints that deal with the value columns <span class="arithmatex">\(\texttt{val[0..7]}\)</span>.</p>
<div class="arithmatex">\[
\begin{align}
&amp;\left( 1 - \texttt{mOp}' \cdot \texttt{mWr}' \right) \cdot \left(1 - \texttt{lastAccess}\right) \cdot (\texttt{val[0..7]}' - \texttt{val[0..7]}) = 0, \tag{7}\\
&amp;\left( 1 - \texttt{mOp}' \cdot \texttt{mWr}' \right) \cdot \texttt{lastAccess} \cdot \texttt{val[0..7]}' = 0. \tag{8}
\end{align}
\]</div>
<p>We analyze both Eqs. (7) and (8) at the same time. Notice that we simply discuss the feasible cases:</p>
<ul>
<li><span class="arithmatex">\(\textbf{Maintain the same value when reading:}\)</span> If <span class="arithmatex">\(\texttt{mWr}' = 0\)</span> and <span class="arithmatex">\(\texttt{lastAccess} = 0\)</span>, then it should be the case that <span class="arithmatex">\(\texttt{val[0..7]}' = \texttt{val[0..7]}\)</span>, since this means that we will perform a read in the next step. Eq. (7) ensures this case.</li>
<li><span class="arithmatex">\(\textbf{Filling the value with zeros when done:}\)</span> If <span class="arithmatex">\(\texttt{mOp}' = 1\)</span>, <span class="arithmatex">\(\texttt{mWr}' = 0\)</span> and <span class="arithmatex">\(\texttt{lastAccess} = 1\)</span>, then it should be the case that <span class="arithmatex">\(\texttt{val[0..7]}' = 0\)</span>, i.e., the register <span class="arithmatex">\(\texttt{val[0..7]}\)</span> is set to <span class="arithmatex">\(0\)</span> in the forthcoming steps.</li>
</ul>
<p>More cases are not possible because for an address we always start with a write operation which limits the behavior of these constraints to these cases. For example, it cannot happen that <span class="arithmatex">\(\texttt{lastAccess = 1}\)</span> and some of <span class="arithmatex">\(\texttt{mOp}'\)</span> or <span class="arithmatex">\(\texttt{mWr}'\)</span> is 0; because the first operation that is always performed over a memory address is a write.</p>
<p>However, notice that to be able reset <span class="arithmatex">\(\texttt{addr}\)</span> to its state in the first row (where it is the case that <span class="arithmatex">\(\texttt{addr}' &lt; \texttt{addr}\)</span>) it should be the case that <span class="arithmatex">\(\texttt{lastAccess} = 1\)</span> in the last row of the computational case. If <span class="arithmatex">\(\texttt{lastAccess}\)</span> would have not been set to <span class="arithmatex">\(1\)</span>, then Eq. (2) would not be satisfied.</p>
<p>We obtain this condition by adding the following constraint:</p>
<div class="arithmatex">\[
\left(1 - \texttt{lastAccess}\right) \cdot \left(1 - \texttt{ISNOTLAST}\right) = 0.
\]</div>
<h3 id="connection-with-the-main-sm">Connection with the Main SM</h3>
<p>The last constraint that we need to add is to relate the execution trace of the Main SM with the execution trace of the Memory SM.</p>
<p>The constraint has to check that all the rows in the trace of the Main SM that make memory operations (i.e. rows where <span class="arithmatex">\(\texttt{mOp} == 1\)</span>) are a permutation (any permutation) of the rows of the Memory SM where <span class="arithmatex">\(\texttt{mOp} == 1\)</span>.</p>
<p>The key point is that if both vectors would not be a permutation of each other, then that would mean that the Main SM is performing an incorrect memory action.</p>

              
            </article>
            
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../../Binary/Binary-State-Machine-typ/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Binary" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Binary
            </div>
          </div>
        </a>
      
      
        
        <a href="../../Memory-Align/memory-align-state-machine/" class="md-footer__link md-footer__link--next" aria-label="Next: Memory Align" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Memory Align
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://t.me/polygonhermez" target="_blank" rel="noopener" title="t.me" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M248 8C111.033 8 0 119.033 0 256s111.033 248 248 248 248-111.033 248-248S384.967 8 248 8Zm114.952 168.66c-3.732 39.215-19.881 134.378-28.1 178.3-3.476 18.584-10.322 24.816-16.948 25.425-14.4 1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25 5.342-39.5 3.652-3.793 67.107-61.51 68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608 69.142-14.845 10.194-26.894 9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7 18.45-13.7 108.446-47.248 144.628-62.3c68.872-28.647 83.183-33.623 92.511-33.789 2.052-.034 6.639.474 9.61 2.885a10.452 10.452 0 0 1 3.53 6.716 43.765 43.765 0 0 1 .417 9.769Z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://github.com/hermeznetwork/hermez-docs" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.tracking"], "search": "../../../../assets/javascripts/workers/search.b97dbffb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.6c7ad80a.min.js"></script>
      
        <script src="../../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>